# èŠå¤©ç³»ç»Ÿè¾¹ç•Œæƒ…å†µå¤„ç†

## ğŸ“‹ å·²å®ç°çš„è¾¹ç•Œæƒ…å†µå¤„ç†

å‚è€ƒè¯„è®ºç³»ç»Ÿçš„è¾¹ç•Œå¤„ç†æ–¹å¼ï¼ŒèŠå¤©ç³»ç»Ÿä¹Ÿå®ç°äº†å®Œæ•´çš„è¾¹ç•Œæƒ…å†µå¤„ç†ã€‚

### 1. å‘é€æ¶ˆæ¯çš„è¾¹ç•Œå¤„ç†

#### å‚æ•°éªŒè¯
- âœ… æ¶ˆæ¯é•¿åº¦é™åˆ¶ï¼ˆæœ€å¤§5000å­—ç¬¦ï¼‰
- âœ… æ–‡ä»¶å¤§å°é™åˆ¶ï¼ˆæœ€å¤§10MBï¼‰
- âœ… å‚æ•°æ ¼å¼éªŒè¯

#### å¹¶å‘æ§åˆ¶
- âœ… é¡¾é—®é”ï¼ˆAdvisory Lockï¼‰ï¼šé˜²æ­¢åŒä¸€ä¼šè¯çš„å¹¶å‘æ“ä½œ
- âœ… è¡Œçº§é” NOWAITï¼šå¿«é€Ÿå¤±è´¥ï¼Œé¿å…é˜»å¡
- âœ… é”è¶…æ—¶ï¼š10ç§’è‡ªåŠ¨é‡Šæ”¾
- âœ… äº‹åŠ¡è¶…æ—¶ï¼š30ç§’è‡ªåŠ¨å›æ»š

#### çŠ¶æ€æ£€æŸ¥
- âœ… ä¼šè¯æ˜¯å¦å­˜åœ¨ï¼ˆè¿”å› 404ï¼‰
- âœ… ä¼šè¯æ˜¯å¦å·²åˆ é™¤ï¼ˆè¿”å› 410ï¼‰
- âœ… ç”¨æˆ·æ˜¯å¦æ˜¯ä¼šè¯æˆå‘˜ï¼ˆè¿”å› 422ï¼‰
- âœ… ä¼šè¯æ˜¯å¦æ­£åœ¨è¢«æ“ä½œï¼ˆè¿”å› 423ï¼‰

#### é€Ÿç‡é™åˆ¶
- âœ… è¿ç»­å‘é€æ¶ˆæ¯æœ€å°é—´éš”ï¼š1ç§’
- âœ… é˜²æ­¢æ¶ˆæ¯è½°ç‚¸

### 2. åˆ›å»ºç¾¤èŠçš„è¾¹ç•Œå¤„ç†

#### å‚æ•°éªŒè¯
- âœ… ç¾¤èŠåç§°ä¸èƒ½ä¸ºç©º
- âœ… ç¾¤èŠåç§°é•¿åº¦é™åˆ¶ï¼ˆæœ€å¤§100å­—ç¬¦ï¼‰
- âœ… ç¾¤æˆå‘˜æ•°é‡é™åˆ¶ï¼ˆæœ€å¤§500äººï¼‰
- âœ… æˆå‘˜IDå»é‡

#### å¹¶å‘æ§åˆ¶
- âœ… äº‹åŠ¡è¶…æ—¶ä¿æŠ¤
- âœ… æäº¤è¶…æ—¶ä¿æŠ¤

### 3. é‚€è¯·åŠ å…¥ç¾¤èŠçš„è¾¹ç•Œå¤„ç†

#### å‚æ•°éªŒè¯
- âœ… é‚€è¯·åˆ—è¡¨ä¸èƒ½ä¸ºç©º
- âœ… ç”¨æˆ·IDå»é‡
- âœ… ç¾¤æˆå‘˜æ•°é‡æ£€æŸ¥ï¼ˆä¸è¶…è¿‡æœ€å¤§é™åˆ¶ï¼‰

#### æƒé™æ£€æŸ¥
- âœ… é‚€è¯·è€…å¿…é¡»æ˜¯ç¾¤æˆå‘˜
- âœ… åªèƒ½é‚€è¯·åŠ å…¥ç¾¤èŠï¼ˆä¸èƒ½é‚€è¯·åŠ å…¥ç§èŠï¼‰

#### çŠ¶æ€æ£€æŸ¥
- âœ… ä¼šè¯æ˜¯å¦å­˜åœ¨
- âœ… ä¼šè¯æ˜¯å¦å·²åˆ é™¤
- âœ… ä¼šè¯ç±»å‹æ˜¯å¦æ­£ç¡®

#### å¹¶å‘æ§åˆ¶
- âœ… é¡¾é—®é”
- âœ… è¡Œçº§é” NOWAIT
- âœ… é”è¶…æ—¶å’Œäº‹åŠ¡è¶…æ—¶

### 4. é€€å‡ºç¾¤èŠçš„è¾¹ç•Œå¤„ç†

#### æƒé™æ£€æŸ¥
- âœ… åªèƒ½é€€å‡ºç¾¤èŠï¼ˆä¸èƒ½é€€å‡ºç§èŠï¼‰
- âœ… ç¾¤ä¸»ä¸èƒ½é€€å‡ºï¼ˆéœ€è¦å…ˆè½¬è®©æˆ–è§£æ•£ï¼‰
- âœ… å¿…é¡»æ˜¯ç¾¤æˆå‘˜

#### çŠ¶æ€æ£€æŸ¥
- âœ… ä¼šè¯æ˜¯å¦å­˜åœ¨
- âœ… ä¼šè¯æ˜¯å¦å·²åˆ é™¤
- âœ… ç”¨æˆ·æ˜¯å¦å·²ç»é€€å‡ºï¼ˆé˜²æ­¢é‡å¤é€€å‡ºï¼‰

#### å¹¶å‘æ§åˆ¶
- âœ… é¡¾é—®é”
- âœ… è¡Œçº§é” NOWAIT
- âœ… è¶…æ—¶ä¿æŠ¤

### 5. åˆ é™¤ä¼šè¯çš„è¾¹ç•Œå¤„ç†

#### æƒé™æ£€æŸ¥
- âœ… ç¾¤èŠï¼šåªæœ‰ç¾¤ä¸»å¯ä»¥è§£æ•£
- âœ… ç§èŠï¼šå¿…é¡»æ˜¯ä¼šè¯æˆå‘˜ä¹‹ä¸€

#### çŠ¶æ€æ£€æŸ¥
- âœ… ä¼šè¯æ˜¯å¦å­˜åœ¨
- âœ… ä¼šè¯æ˜¯å¦å·²åˆ é™¤ï¼ˆé˜²æ­¢é‡å¤åˆ é™¤ï¼‰

#### çº§è”åˆ é™¤
- âœ… è½¯åˆ é™¤ä¼šè¯
- âœ… è½¯åˆ é™¤æ‰€æœ‰æ¶ˆæ¯
- âœ… åˆ é™¤æ‰€æœ‰ç¦»çº¿æ¶ˆæ¯

#### å¹¶å‘æ§åˆ¶
- âœ… é¡¾é—®é”
- âœ… è¡Œçº§é” NOWAIT
- âœ… è¶…æ—¶ä¿æŠ¤

### 6. è·å–æ¶ˆæ¯å†å²çš„è¾¹ç•Œå¤„ç†

#### æƒé™æ£€æŸ¥
- âœ… å¿…é¡»æ˜¯ä¼šè¯æˆå‘˜æ‰èƒ½æŸ¥çœ‹æ¶ˆæ¯

#### çŠ¶æ€æ£€æŸ¥
- âœ… ä¼šè¯æ˜¯å¦å­˜åœ¨
- âœ… ä¼šè¯æ˜¯å¦å·²åˆ é™¤

### 7. ç¦»çº¿æ¶ˆæ¯å¤„ç†

#### è‡ªåŠ¨å­˜å‚¨
- âœ… ç”¨æˆ·åœ¨çº¿ï¼šæ¶ˆæ¯ç›´æ¥æ¨é€ï¼Œä¸å­˜å‚¨
- âœ… ç”¨æˆ·ç¦»çº¿ï¼šè‡ªåŠ¨å­˜å‚¨åˆ° offline_messages è¡¨

#### è‡ªåŠ¨æ¨é€å’Œåˆ é™¤
- âœ… ç”¨æˆ·ä¸Šçº¿æ—¶è‡ªåŠ¨æ¨é€æ‰€æœ‰ç¦»çº¿æ¶ˆæ¯
- âœ… æ¨é€åè‡ªåŠ¨åˆ é™¤æœåŠ¡å™¨è®°å½•

## ğŸ”’ é…ç½®å¸¸é‡

```rust
const MESSAGE_INTERVAL_SECONDS: i64 = 1;        // è¿ç»­å‘é€æ¶ˆæ¯æœ€å°é—´éš”ï¼ˆç§’ï¼‰
const LOCK_TIMEOUT_SECONDS: i64 = 10;           // é”è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
const TRANSACTION_TIMEOUT: Duration = Duration::from_secs(30); // äº‹åŠ¡è¶…æ—¶
const MAX_MESSAGE_LENGTH: usize = 5000;         // æœ€å¤§æ¶ˆæ¯é•¿åº¦
const MAX_GROUP_MEMBERS: usize = 500;           // æœ€å¤§ç¾¤æˆå‘˜æ•°
const MAX_FILE_SIZE: i64 = 10 * 1024 * 1024;   // æœ€å¤§æ–‡ä»¶å¤§å° 10MB
```

## ğŸ“Š é”™è¯¯ç æ˜ å°„

| åœºæ™¯ | é”™è¯¯ç  | è¯´æ˜ |
|------|--------|------|
| ä¼šè¯ä¸å­˜åœ¨ | 404 | NotFound |
| ä¼šè¯å·²åˆ é™¤ | 410 | Gone |
| å‚æ•°éªŒè¯å¤±è´¥ | 422 | Validation |
| ä¼šè¯è¢«é”å®š/å¹¶å‘å†²çª | 423 | Locked |
| æ¶ˆæ¯å‘é€è¿‡äºé¢‘ç¹ | 429 | TooManyRequests |
| äº‹åŠ¡/é”è¶…æ—¶ | 408 | Timeout |
| æœåŠ¡å™¨é”™è¯¯ | 500 | Db |

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

### åœºæ™¯ 1: å‘é€æ¶ˆæ¯æ—¶ä¼šè¯è¢«åˆ é™¤

```rust
// ç”¨æˆ·Aæ­£åœ¨å‘é€æ¶ˆæ¯
let result = chat_service.send_message(
    conversation_id,
    user_a_id,
    MessageType::Text,
    "Hello".to_string(),
    None, None, None
).await;

// å¦‚æœä¼šè¯åœ¨æ­¤æœŸé—´è¢«åˆ é™¤
match result {
    Err(DomainError::Gone) => {
        // è¿”å› 410ï¼Œæç¤º"ä¼šè¯å·²è¢«åˆ é™¤"
        println!("ä¼šè¯å·²è¢«åˆ é™¤ï¼Œæ— æ³•å‘é€æ¶ˆæ¯");
    }
    Ok(message) => {
        println!("æ¶ˆæ¯å‘é€æˆåŠŸ");
    }
    _ => {}
}
```

### åœºæ™¯ 2: è¿ç»­å‘é€æ¶ˆæ¯

```rust
// ç¬¬ä¸€æ¡æ¶ˆæ¯
chat_service.send_message(...).await?;

// ç«‹å³å‘é€ç¬¬äºŒæ¡æ¶ˆæ¯ï¼ˆé—´éš” < 1ç§’ï¼‰
let result = chat_service.send_message(...).await;

match result {
    Err(DomainError::TooManyRequests) => {
        // è¿”å› 429ï¼Œæç¤º"æ¶ˆæ¯å‘é€è¿‡äºé¢‘ç¹"
        println!("è¯·ç¨åå†è¯•");
    }
    _ => {}
}
```

### åœºæ™¯ 3: é‚€è¯·æ—¶ç¾¤æˆå‘˜æ•°è¶…é™

```rust
let result = chat_service.invite_to_group(
    conversation_id,
    inviter_id,
    vec![user1, user2, ...] // å¤ªå¤šç”¨æˆ·
).await;

match result {
    Err(DomainError::Validation(msg)) => {
        // è¿”å› 422ï¼Œæç¤º"ç¾¤æˆå‘˜æ•°é‡å°†è¶…è¿‡é™åˆ¶ï¼ˆæœ€å¤§500äººï¼‰"
        println!("{}", msg);
    }
    _ => {}
}
```

### åœºæ™¯ 4: ç¾¤ä¸»å°è¯•é€€å‡ºç¾¤èŠ

```rust
let result = chat_service.leave_group(conversation_id, owner_id).await;

match result {
    Err(DomainError::Validation(msg)) => {
        // è¿”å› 422ï¼Œæç¤º"ç¾¤ä¸»ä¸èƒ½é€€å‡ºç¾¤èŠï¼Œè¯·å…ˆè½¬è®©ç¾¤ä¸»æˆ–è§£æ•£ç¾¤èŠ"
        println!("{}", msg);
    }
    _ => {}
}
```

### åœºæ™¯ 5: å¹¶å‘åˆ é™¤ä¼šè¯

```rust
// ç”¨æˆ·Aå’Œç”¨æˆ·BåŒæ—¶å°è¯•åˆ é™¤ä¼šè¯
tokio::spawn(async move {
    chat_service.delete_conversation(conv_id, user_a).await
});

tokio::spawn(async move {
    chat_service.delete_conversation(conv_id, user_b).await
});

// ä¸€ä¸ªä¼šæˆåŠŸï¼Œå¦ä¸€ä¸ªä¼šè¿”å›ï¼š
// - 423 Lockedï¼ˆæ­£åœ¨è¢«æ“ä½œï¼‰
// - 410 Goneï¼ˆå·²è¢«åˆ é™¤ï¼‰
```

## ğŸ§ª æµ‹è¯•å»ºè®®

### å•å…ƒæµ‹è¯•

```rust
#[tokio::test]
async fn test_message_interval_limit() {
    let chat_service = setup_test_service().await;
    
    // å‘é€ç¬¬ä¸€æ¡æ¶ˆæ¯
    let msg1 = chat_service.send_message(...).await.unwrap();
    
    // ç«‹å³å‘é€ç¬¬äºŒæ¡æ¶ˆæ¯
    let result = chat_service.send_message(...).await;
    
    // åº”è¯¥è¿”å› TooManyRequests
    assert!(matches!(result, Err(DomainError::TooManyRequests)));
}

#[tokio::test]
async fn test_group_member_limit() {
    let chat_service = setup_test_service().await;
    
    // åˆ›å»ºä¸€ä¸ªæ¥è¿‘ä¸Šé™çš„ç¾¤
    let members: Vec<i64> = (1..=499).collect();
    let conv = chat_service.create_group_conversation(
        owner_id,
        "æµ‹è¯•ç¾¤".to_string(),
        members
    ).await.unwrap();
    
    // å°è¯•å†é‚€è¯·2ä¸ªäººï¼ˆä¼šè¶…è¿‡500äººé™åˆ¶ï¼‰
    let result = chat_service.invite_to_group(
        conv.id,
        owner_id,
        vec![500, 501]
    ).await;
    
    // åº”è¯¥è¿”å› Validation é”™è¯¯
    assert!(matches!(result, Err(DomainError::Validation(_))));
}
```

### é›†æˆæµ‹è¯•

```python
# test_chat_edge_cases.py

def test_send_message_to_deleted_conversation():
    """æµ‹è¯•å‘å·²åˆ é™¤çš„ä¼šè¯å‘é€æ¶ˆæ¯"""
    # 1. åˆ›å»ºä¼šè¯
    conv = create_conversation(user1, user2)
    
    # 2. åˆ é™¤ä¼šè¯
    delete_conversation(conv.id, user1)
    
    # 3. å°è¯•å‘é€æ¶ˆæ¯
    response = send_message(conv.id, user1, "Hello")
    
    # åº”è¯¥è¿”å› 410 Gone
    assert response.status_code == 410
    assert "å·²è¢«åˆ é™¤" in response.json()["message"]

def test_concurrent_message_sending():
    """æµ‹è¯•å¹¶å‘å‘é€æ¶ˆæ¯"""
    conv = create_conversation(user1, user2)
    
    # å¿«é€Ÿè¿ç»­å‘é€å¤šæ¡æ¶ˆæ¯
    results = []
    for i in range(5):
        result = send_message(conv.id, user1, f"Message {i}")
        results.append(result)
        time.sleep(0.5)  # é—´éš”0.5ç§’
    
    # åº”è¯¥æœ‰ä¸€äº›è¯·æ±‚è¢«é™æµ
    failed = [r for r in results if r.status_code == 429]
    assert len(failed) > 0
```

## ğŸ”„ ä¸è¯„è®ºç³»ç»Ÿçš„å¯¹æ¯”

| ç‰¹æ€§ | è¯„è®ºç³»ç»Ÿ | èŠå¤©ç³»ç»Ÿ |
|------|----------|----------|
| å¹¶å‘æ§åˆ¶ | âœ… é¡¾é—®é” + è¡Œçº§é” | âœ… é¡¾é—®é” + è¡Œçº§é” |
| é”è¶…æ—¶ | âœ… 10ç§’ | âœ… 10ç§’ |
| äº‹åŠ¡è¶…æ—¶ | âœ… 30ç§’ | âœ… 30ç§’ |
| é€Ÿç‡é™åˆ¶ | âœ… 3ç§’é—´éš” | âœ… 1ç§’é—´éš” |
| è½¯åˆ é™¤ | âœ… çº§è”åˆ é™¤ | âœ… çº§è”åˆ é™¤ |
| çŠ¶æ€æ£€æŸ¥ | âœ… å¸–å­/è¯„è®ºçŠ¶æ€ | âœ… ä¼šè¯/æˆå‘˜çŠ¶æ€ |
| æƒé™æ£€æŸ¥ | âœ… æ˜¯å¦æ˜¯ä½œè€… | âœ… æ˜¯å¦æ˜¯æˆå‘˜/ç¾¤ä¸» |
| å‚æ•°éªŒè¯ | âœ… é•¿åº¦/å±‚çº§ | âœ… é•¿åº¦/æ•°é‡ |

## âœ… æ€»ç»“

èŠå¤©ç³»ç»Ÿçš„è¾¹ç•Œæƒ…å†µå¤„ç†å·²ç»å®Œå…¨å®ç°ï¼ŒåŒ…æ‹¬ï¼š

1. **å®Œæ•´çš„å¹¶å‘æ§åˆ¶**ï¼šé¡¾é—®é” + è¡Œçº§é” + è¶…æ—¶ä¿æŠ¤
2. **ä¸¥æ ¼çš„å‚æ•°éªŒè¯**ï¼šé•¿åº¦ã€æ•°é‡ã€æ ¼å¼æ£€æŸ¥
3. **ç»†è‡´çš„æƒé™æ£€æŸ¥**ï¼šæˆå‘˜ã€ç¾¤ä¸»æƒé™éªŒè¯
4. **å…¨é¢çš„çŠ¶æ€æ£€æŸ¥**ï¼šå­˜åœ¨ã€åˆ é™¤ã€é”å®šçŠ¶æ€
5. **æ™ºèƒ½çš„é€Ÿç‡é™åˆ¶**ï¼šé˜²æ­¢æ¶ˆæ¯è½°ç‚¸
6. **å®‰å…¨çš„çº§è”åˆ é™¤**ï¼šè½¯åˆ é™¤ + æ¸…ç†ç¦»çº¿æ¶ˆæ¯

æ‰€æœ‰è¾¹ç•Œæƒ…å†µéƒ½ç»è¿‡ç²¾å¿ƒè®¾è®¡ï¼Œç¡®ä¿ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œå®‰å…¨æ€§ï¼ğŸ‰
